<!DOCTYPE html>
<html class="dark" lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>單品庫存管理</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#53d22d",
                        "background-light": "#f6f8f6",
                        "background-dark": "#152012",
                    },
                    fontFamily: {
                        "display": ["Manrope", "Noto Sans TC", "sans-serif"],
                        "mono": ["ui-monospace", "SFMono-Regular", "Menlo", "Monaco", "Consolas", "Liberation Mono", "Courier New", "monospace"],
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "0.75rem", "xl": "1rem", "2xl": "1.5rem", "full": "9999px" },
                },
            },
        }
    </script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;family=Noto+Sans+TC:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            min-height: max(884px, 100dvh);
            -webkit-tap-highlight-color: transparent;
        }

        .glass-effect {
            background: rgba(31, 37, 29, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ios-tab-bar {
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        /* Swipe to delete styles */
        .swipe-item-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            margin-bottom: 1rem;
            touch-action: pan-y;
            /* Allow vertical scroll, handle horizontal in JS */
            user-select: none;
            /* Prevent text selection during swipe */
            cursor: grab;
        }

        .swipe-item-wrapper:active {
            cursor: grabbing;
        }

        .swipe-item-content {
            position: relative;
            z-index: 10;
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: inherit;
            will-change: transform;
        }

        .swipe-delete-actions {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            z-index: 5;
            width: 100%;
        }

        .swipe-delete-btn {
            background-color: #ff3b30;
            color: white;
            width: 80px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            font-weight: bold;
        }

        .swipe-delete-btn:active {
            filter: brightness(0.85);
        }

        .swipe-item-wrapper.swiped .swipe-item-content {
            transform: translateX(-80px);
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display antialiased text-slate-900 dark:text-white selection:bg-primary selection:text-white">
    <div
        class="relative flex h-full min-h-screen w-full flex-col overflow-x-hidden max-w-md mx-auto shadow-2xl bg-background-light dark:bg-background-dark pb-32">
        <div
            class="sticky top-0 z-20 bg-background-light/90 dark:bg-background-dark/90 backdrop-blur-md px-4 pt-4 pb-2">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-extrabold leading-tight tracking-tight">單品庫存管理</h2>
                <div class="flex gap-2">
                    <button onclick="exportData()"
                        class="flex items-center justify-center rounded-full h-10 w-10 bg-white dark:bg-white/10 text-slate-600 dark:text-slate-300 hover:bg-opacity-90 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[20px]">ios_share</span>
                    </button>
                    <button onclick="document.getElementById('importFile').click()"
                        class="flex items-center justify-center rounded-full h-10 w-10 bg-white dark:bg-white/10 text-slate-600 dark:text-slate-300 hover:bg-opacity-90 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-[20px]">download</span>
                    </button>
                    <button onclick="testConnection()"
                        class="flex items-center justify-center rounded-full h-10 w-10 bg-blue-500 text-white hover:bg-opacity-90 transition-colors shadow-sm"
                        title="測試 Firebase 連線">
                        <span class="material-symbols-outlined text-[20px]">wifi</span>
                    </button>
                    <a href="../新增吉他庫存/code.html"
                        class="flex items-center justify-center rounded-full h-10 w-10 bg-primary text-white hover:bg-opacity-90 transition-colors shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-[24px]">add</span>
                    </a>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)" />
                </div>
            </div>
            <div class="relative w-full">
                <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                    <span class="material-symbols-outlined text-slate-400 dark:text-slate-500">search</span>
                </div>
                <input id="search-input" oninput="renderInventory()"
                    class="block w-full h-12 rounded-full border-none bg-white dark:bg-white/10 pl-11 pr-4 text-base text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-primary shadow-sm"
                    placeholder="搜尋序號或品牌..." type="text" />
            </div>
            <div id="category-filter" class="flex gap-3 mt-4 overflow-x-auto no-scrollbar pb-2">
                <button onclick="setFilter('全部')" id="filter-全部"
                    class="flex h-9 shrink-0 items-center justify-center rounded-full bg-slate-900 dark:bg-white px-5 transition-colors">
                    <span class="text-white dark:text-background-dark text-sm font-bold">全部</span>
                </button>
                <button onclick="setFilter('新品')" id="filter-新品"
                    class="flex h-9 shrink-0 items-center justify-center rounded-full bg-white dark:bg-white/10 border border-slate-200 dark:border-transparent px-5 transition-colors hover:bg-slate-100 dark:hover:bg-white/20">
                    <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">新品</span>
                </button>
                <button onclick="setFilter('二手')" id="filter-二手"
                    class="flex h-9 shrink-0 items-center justify-center rounded-full bg-white dark:bg-white/10 border border-slate-200 dark:border-transparent px-5 transition-colors hover:bg-slate-100 dark:hover:bg-white/20">
                    <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">二手</span>
                </button>
                <button onclick="setFilter('已售出')" id="filter-已售出"
                    class="flex h-9 shrink-0 items-center justify-center rounded-full bg-white dark:bg-white/10 border border-slate-200 dark:border-transparent px-5 transition-colors hover:bg-slate-100 dark:hover:bg-white/20">
                    <span class="text-slate-600 dark:text-slate-300 text-sm font-medium">已售出</span>
                </button>
            </div>
        </div>
        <div id="inventory-list" class="flex flex-col px-4 mt-2">
            <!-- JavaScript 會在這裡動態渲染卡片 -->
        </div>
        <div class="h-8"></div>

        <!-- 引入 Firebase SDK (CDN 版本) -->
        <script type="module">
            // 1. 引入必要的 Firebase 功能
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            // 2. 你的鑰匙
            const firebaseConfig = {
                apiKey: "AIzaSyBGDUjeYPCwESykwTWStz7GLMe1ujzEr08",
                authDomain: "test-5e965.firebaseapp.com",
                projectId: "test-5e965",
                storageBucket: "test-5e965.firebasestorage.app",
                messagingSenderId: "42477514336",
                appId: "1:42477514336:web:e6495a7c4081d780c89d05",
                measurementId: "G-G9ZEBGGZQM"
            };

            // 3. 初始化 Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // 暴露給全域
            window.db = db;

            // --- 雲端同步核心功能 ---

            // 1. 遷移資料 (從手機搬到雲端)
            window.migrateToCloud = async () => {
                const localData = JSON.parse(localStorage.getItem('stitch_inventory_all') || '[]');
                if (localData.length === 0) {
                    alert('手機目前沒有舊資料可以搬遷。');
                    return;
                }

                if (!confirm(`發現 ${localData.length} 筆手機舊資料，要現在搬遷到雲端嗎？\n(搬遷後手機資料將被清空)`)) return;

                const btn = document.querySelector('button[title="測試 Firebase 連線"]');
                btn.disabled = true;

                try {
                    for (const item of localData) {
                        const cloudItem = { ...item, createdAt: serverTimestamp() };
                        delete cloudItem.id; // 讓 Firestore 生成新的 ID
                        await addDoc(collection(db, "inventory"), cloudItem);
                    }
                    localStorage.removeItem('stitch_inventory_all');
                    localStorage.removeItem('stitch_inventory');
                    alert('✅ 全部資料搬遷雲端成功！');
                    window.location.reload();
                } catch (e) {
                    alert('❌ 搬遷失敗: ' + e.message);
                } finally {
                    btn.disabled = false;
                }
            };

            // 2. 全域刪除
            window.deleteItem = async (docId) => {
                if (!confirm('確定要從雲端刪除此項目嗎？')) return;
                try {
                    await deleteDoc(doc(db, "inventory", docId));
                    renderInventory();
                } catch (e) {
                    alert('刪除失敗: ' + e.message);
                }
            };

            // 3. 全域切換庫存狀態
            window.toggleSold = async (docId, currentStatus) => {
                try {
                    await updateDoc(doc(db, "inventory", docId), {
                        inStock: !currentStatus
                    });
                    renderInventory();
                } catch (e) {
                    alert('更新失敗: ' + e.message);
                }
            };

            // 4. 測試連線
            window.testConnection = async () => {
                try {
                    const docRef = await addDoc(collection(db, "test_connection"), {
                        timestamp: new Date(),
                        message: "Hello from Cloud!"
                    });
                    alert("✅ 連線成功！雲端 ID: " + docRef.id);
                } catch (e) {
                    alert("❌ 連線失敗: " + e.message);
                }
            }

            // --- 頁面邏輯 ---
            let currentFilter = '全部';

            window.setFilter = (category) => {
                currentFilter = category;
                const categories = ['全部', '新品', '二手', '已售出'];
                categories.forEach(cat => {
                    const btn = document.getElementById(`filter-${cat}`);
                    if (cat === category) {
                        btn.className = "flex h-9 shrink-0 items-center justify-center rounded-full bg-slate-900 dark:bg-white px-5 transition-colors";
                        btn.querySelector('span').className = "text-white dark:text-background-dark text-sm font-bold";
                    } else {
                        btn.className = "flex h-9 shrink-0 items-center justify-center rounded-full bg-white dark:bg-white/10 border border-slate-200 dark:border-transparent px-5 transition-colors hover:bg-slate-100 dark:hover:bg-white/20";
                        btn.querySelector('span').className = "text-slate-600 dark:text-slate-300 text-sm font-medium";
                    }
                });
                renderInventory();
            };

            window.renderInventory = async () => {
                const listContainer = document.getElementById('inventory-list');
                const searchQuery = document.getElementById('search-input').value.toLowerCase();

                listContainer.innerHTML = '<div class="py-20 text-center text-slate-400">讀取雲端資料中...</div>';

                try {
                    const q = query(collection(db, "inventory"), orderBy("createdAt", "desc"));
                    const querySnapshot = await getDocs(q);
                    let allItems = [];
                    querySnapshot.forEach((doc) => {
                        allItems.push({ docId: doc.id, ...doc.data() });
                    });

                    // 搜尋過濾
                    let filteredItems = allItems.filter(item =>
                        (item.brand && item.brand.toLowerCase().includes(searchQuery)) ||
                        (item.model && item.model.toLowerCase().includes(searchQuery)) ||
                        (item.serial && item.serial.toLowerCase().includes(searchQuery))
                    );

                    // 類別過濾
                    if (currentFilter === '新品') {
                        filteredItems = filteredItems.filter(item => item.status === '新品' && item.inStock);
                    } else if (currentFilter === '二手') {
                        filteredItems = filteredItems.filter(item => item.status === '二手' && item.inStock);
                    } else if (currentFilter === '已售出') {
                        filteredItems = filteredItems.filter(item => !item.inStock);
                    }

                    if (filteredItems.length === 0) {
                        listContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                                <span class="material-symbols-outlined text-6xl mb-4">inventory_2</span>
                                <p>沒有找到相關項目</p>
                                ${allItems.length === 0 ? '<button onclick="migrateToCloud()" class="mt-4 text-primary underline">搬遷手機舊資料到雲端</button>' : ''}
                            </div>
                        `;
                        return;
                    }

                    function getCurrencySymbol(currency) {
                        switch (currency) {
                            case 'USD': return '$';
                            case 'JPY': return '¥';
                            case 'TWD': return 'NT$';
                            default: return (currency || '') + ' ';
                        }
                    }

                    listContainer.innerHTML = filteredItems.map(item => `
                        <div class="swipe-item-wrapper" 
                             ontouchstart="onTouchStart(event)" 
                             ontouchmove="onTouchMove(event)" 
                             ontouchend="onTouchEnd(event)"
                             onmousedown="onMouseDown(event)"
                             onmousemove="onMouseMove(event)"
                             onmouseup="onMouseUp(event)"
                             onmouseleave="onMouseLeave(event)">
                            <div class="swipe-delete-actions">
                                <button onclick="deleteItem('${item.docId}')" class="swipe-delete-btn">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                            <div class="swipe-item-content bg-background-light dark:bg-background-dark">
                                <div class="group relative flex flex-col gap-3 rounded-2xl bg-white dark:bg-white/5 p-3 shadow-sm border border-slate-100 dark:border-white/5 active:scale-[0.98] transition-all duration-200 ${!item.inStock ? 'grayscale opacity-50' : ''}">
                                    <div class="flex items-start gap-4">
                                        <div class="relative shrink-0 overflow-hidden rounded-xl h-20 w-20 bg-slate-100 dark:bg-white/10">
                                            <img src="${item.image || 'https://via.placeholder.com/150?text=Guitar'}" class="h-full w-full object-cover" />
                                        </div>
                                        <div class="flex flex-1 flex-col justify-between min-h-[5rem]">
                                            <div>
                                                <div class="flex justify-between items-start gap-2">
                                                    <h3 class="text-base font-bold text-slate-900 dark:text-white line-clamp-1">${item.brand} ${item.model}</h3>
                                                    <div onclick="toggleSold('${item.docId}', ${item.inStock})" class="flex h-8 w-8 items-center justify-center rounded-full bg-slate-100 dark:bg-white/10 cursor-pointer hover:bg-primary hover:text-white transition-colors">
                                                        <span class="material-symbols-outlined text-sm">${item.inStock ? 'shopping_cart' : 'undo'}</span>
                                                    </div>
                                                </div>
                                                <p class="font-mono text-xs text-slate-500 dark:text-slate-400 mt-1">序號: ${item.serial || 'N/A'}</p>
                                            </div>
                                            <div class="flex items-center gap-2 mt-2">
                                                <div class="flex flex-col flex-1">
                                                    <div class="flex items-center gap-2">
                                                        <span class="${item.status === '新品' ? 'bg-primary text-white' : 'border border-slate-200 dark:border-white/20 text-slate-600 dark:text-slate-300'} inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-bold">
                                                            ${item.status}
                                                        </span>
                                                        <span class="inline-flex items-center gap-1 rounded-full ${item.inStock ? 'bg-primary/10 text-primary' : 'bg-slate-200 text-slate-500'} px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide">
                                                            ${item.inStock ? '庫存中' : '已售出'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col items-end shrink-0">
                                                    <span class="text-base font-bold text-slate-900 dark:text-white">${getCurrencySymbol(item.currency)}${Number(item.amount || 0).toLocaleString()}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    listContainer.innerHTML = `<div class="py-20 text-center text-red-400">讀取失敗：${e.message}</div>`;
                }
            };

            window.exportData = async () => {
                try {
                    const querySnapshot = await getDocs(collection(db, "inventory"));
                    let data = [];
                    querySnapshot.forEach(doc => data.push(doc.data()));

                    if (data.length === 0) {
                        alert('沒有可匯出的雲端資料');
                        return;
                    }

                    const headers = ['品牌', '型號', '序號', '狀態', '庫存狀態', '幣別', '金額', '圖片網址'];
                    const rows = data.map(item => [
                        `"${(item.brand || '').replace(/"/g, '""')}"`,
                        `"${(item.model || '').replace(/"/g, '""')}"`,
                        `"${(item.serial || '').replace(/"/g, '""')}"`,
                        item.status,
                        item.inStock ? '庫存中' : '已售出',
                        item.currency,
                        item.amount,
                        item.image || ''
                    ]);

                    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date().toISOString().split('T')[0];
                    a.href = url;
                    a.download = `吉他庫存雲端報表_${date}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert('匯出失敗: ' + e.message);
                }
            };

            window.onload = renderInventory;
        </script>

        <script>
            // 預設庫存資料 (不再使用，但保留以防萬一)
            const defaultInventory = [
                {
                    id: 1, brand: 'Gibson', model: "Les Paul Standard '59", year: '1959', origin: 'USA',
                    serial: '9 1234', status: '二手', amount: '5400', currency: 'USD',
                    image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuBM44Lt5Hru_S_NE-kyM2guicgaF5DO3G9qrdSB3ljUkzemEi9F9ezXlrhvc4tQuphid6vjOkxWfmoGERhEljIhSDNaG5FmPmTL5-Q09aV0hd50BKXNdrQ5iJQB9WT0Aue8dVT2P3AWJ1CL_zCMZz4rRRz25JDoCg8K-NWFMWUrfO7BV1dkEmVkuaIMnSYRrgOzfjXh-0O2id2UMH_3a88hvMJG3paapNFunyRRVqEzjV8t4QxFafwPWSVsJXwbaSC6N2ix6gWcU4Db',
                    inStock: true
                },
                {
                    id: 2, brand: 'Fender', model: 'Stratocaster Am Pro II', year: '2021', origin: 'USA',
                    serial: 'US190234', status: '新品', amount: '1699', currency: 'USD',
                    image: 'https://lh3.googleusercontent.com/aida-public/AB6AXuDwMyvtWcfT8ZVuwfcWjMbiMkVibtoJNE03a7deW6jaXV1O3L5J_6w3QkPVS-AaYaFO0eTt8sl4DRywIcGVjIhCY_EOsjMyzlMK1lj-_Th9Yn79MYn8nAWnB1AYNs604OrcJxXaEhobNzIUCOHo78Pg4HE4E7IjP99SuZNhPBomlNUhFM-CZRGpKDurc-2xST2c1sbkAPU3m_HS0AoHM-DFm5BZ2fK9GqWaN_yfehUpsQzt1ULza6CoyoBGnAeV7ZMguYAGrPYX9AMs',
                    inStock: true
                }
            ];

            // 以下函數已移至 type="module" 腳本中，此處僅為兼容性保留或待移除
            // function getCurrencySymbol(currency) { /* ... */ }
            // function toggleInStock(id) { /* ... */ }
            // function syncData() { /* ... */ }
            // function toggleSold(id) { /* ... */ }
            // function deleteItem(id) { /* ... */ }
            // function setFilter(category) { /* ... */ }
            // function renderInventory() { /* ... */ }
            // function exportData() { /* ... */ }

            // --- Swipe Logic (Touch & Mouse) ---
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let isSwiping = false;
            let isScrolling = false;
            let activeItem = null;

            // Helper: Close any currently open item
            function closeCurrentSwiped() {
                const openItem = document.querySelector('.swipe-item-wrapper.swiped');
                if (openItem) {
                    openItem.classList.remove('swiped');
                    const content = openItem.querySelector('.swipe-item-content');
                    if (content) content.style.transform = '';
                }
            }

            // Universal Start Handler
            function handleStart(clientX, clientY, target) {
                const wrapper = target.closest('.swipe-item-wrapper');
                if (!wrapper) return;

                const currentlySwiped = document.querySelector('.swipe-item-wrapper.swiped');
                if (currentlySwiped && currentlySwiped !== wrapper) {
                    closeCurrentSwiped();
                }

                activeItem = wrapper;
                startX = clientX;
                startY = clientY;
                isSwiping = false;
                isScrolling = false;

                const content = activeItem.querySelector('.swipe-item-content');
                content.style.transition = 'none';
            }

            // Universal Move Handler
            function handleMove(clientX, clientY) {
                if (!activeItem || isScrolling) return;

                const diffX = clientX - startX;
                const diffY = clientY - startY;

                // Vertical scrolling detection
                if (!isSwiping && !isScrolling) {
                    if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 5) {
                        isScrolling = true;
                        const content = activeItem.querySelector('.swipe-item-content');
                        content.style.transition = '';
                        return;
                    }
                    if (Math.abs(diffX) > 5) {
                        isSwiping = true;
                    }
                }

                if (isSwiping) {
                    const isAlreadyOpen = activeItem.classList.contains('swiped');
                    let newTranslate = diffX;
                    if (isAlreadyOpen) {
                        newTranslate = diffX - 80;
                    }

                    if (newTranslate > 0) newTranslate = 0;
                    if (newTranslate < -120) newTranslate = -120;

                    const content = activeItem.querySelector('.swipe-item-content');
                    content.style.transform = `translateX(${newTranslate}px)`;
                    currentX = newTranslate;
                }
            }

            // Universal End Handler
            function handleEnd() {
                if (!activeItem) return;

                const content = activeItem.querySelector('.swipe-item-content');
                content.style.transition = 'transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1)';

                if (isSwiping) {
                    if (currentX < -40) {
                        activeItem.classList.add('swiped');
                        content.style.transform = 'translateX(-80px)';
                    } else {
                        activeItem.classList.remove('swiped');
                        content.style.transform = '';
                    }
                } else {
                    if (activeItem.classList.contains('swiped')) {
                        activeItem.classList.remove('swiped');
                        content.style.transform = '';
                    }
                }

                activeItem = null;
                isSwiping = false;
                isScrolling = false;
                currentX = 0;
            }

            // --- Touch Events ---
            function onTouchStart(e) {
                if (e.target.closest('button') || e.target.closest('.swipe-delete-btn')) return;
                handleStart(e.touches[0].clientX, e.touches[0].clientY, e.target);
            }

            function onTouchMove(e) {
                if (!activeItem) return;
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
                if (isSwiping && e.cancelable) {
                    e.preventDefault();
                }
            }

            function onTouchEnd(e) {
                handleEnd();
            }

            // --- Mouse Events ---
            function onMouseDown(e) {
                if (e.target.closest('button') || e.target.closest('.swipe-delete-btn')) return;
                handleStart(e.clientX, e.clientY, e.target);
            }

            function onMouseMove(e) {
                if (e.buttons !== 1) return;
                handleMove(e.clientX, e.clientY);
            }

            function onMouseUp(e) {
                handleEnd();
            }

            function onMouseLeave(e) {
                handleEnd();
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('匯入將會覆蓋目前的庫存資料，確定要繼續嗎？')) {
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const content = e.target.result;
                        // 驗證 JSON 格式
                        JSON.parse(content);
                        localStorage.setItem('stitch_inventory_all', content);
                        alert('資料匯入成功！');
                        renderInventory();
                    } catch (err) {
                        alert('錯誤：無效的備份檔案格式');
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // 清除 input 讓同一個檔案可以重複觸發變更
            }

            window.onload = renderInventory;
        </script>
        <!-- iOS Bottom Tab Bar -->
        <nav
            class="fixed bottom-0 left-0 right-0 glass-effect ios-tab-bar px-6 flex justify-between items-center z-50 max-w-md mx-auto">
            <a href="../匯率追蹤器/dashboard.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">home</span>
                <span class="text-[10px] mt-1">首頁</span>
            </a>
            <a href="../匯率追蹤器/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">payments</span>
                <span class="text-[10px] mt-1">匯率</span>
            </a>
            <a href="code.html" class="flex flex-col items-center p-3 text-primary">
                <span class="material-symbols-outlined fill-[1]">box</span>
                <span class="text-[10px] mt-1 font-bold">庫存</span>
            </a>
            <a href="../落地成本計算器/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">receipt_long</span>
                <span class="text-[10px] mt-1">成本</span>
            </a>
            <a href="../銷售記錄與利潤分析/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">monitoring</span>
                <span class="text-[10px] mt-1">分析</span>
            </a>
        </nav>
    </div>
</body>

</html>
