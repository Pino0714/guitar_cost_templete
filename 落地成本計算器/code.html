<!DOCTYPE html>
<html class="dark" lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>落地成本計算器</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#53d22d",
                        "background-light": "#f6f8f6",
                        "background-dark": "#152012",
                        "surface-dark": "#1f251d", // Consistent surface color
                        "border-dark": "#42513e",  // Consistent border color
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
    body {
    min-height: max(884px, 100dvh);
    -webkit-tap-highlight-color: transparent;
    }

    .glass-effect {
    background: rgba(31, 37, 29, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ios-tab-bar {
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    </style>
</head>

<body class="bg-gray-900 font-display">
    <div
        class="relative flex h-full min-h-screen w-full max-w-md flex-col bg-background-light dark:bg-background-dark overflow-hidden shadow-2xl mx-auto">
        <header
            class="flex items-center justify-between px-6 pt-12 pb-4 bg-background-light dark:bg-background-dark z-10 sticky top-0">
            <div class="flex items-center gap-3">
                <a href="../匯率追蹤器/dashboard.html"
                    class="flex items-center justify-center w-10 h-10 rounded-full hover:bg-white/5 transition-colors">
                    <span class="material-symbols-outlined text-white text-2xl">arrow_back</span>
                </a>
                <h2 class="text-white text-xl font-extrabold leading-tight tracking-tight">落地成本計算器</h2>
            </div>
            <button onclick="clearFields()"
                class="text-[#a5b6a0] hover:text-white text-sm font-bold leading-normal tracking-wide transition-colors">
                清除
            </button>
        </header>
        <main class="flex-1 overflow-y-auto no-scrollbar px-5 pb-48">
            <div
                class="mt-2 mb-6 p-5 rounded-2xl bg-surface-dark border border-border-dark relative overflow-hidden group shadow-lg">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <span class="material-symbols-outlined text-6xl text-primary">currency_exchange</span>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <select id="base-currency" onchange="updateExchangeRate()"
                                class="bg-transparent border-none p-0 text-[#a5b6a0] text-sm font-semibold uppercase tracking-wider focus:ring-0 cursor-pointer">
                                <option value="JPY" selected>JPY</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                            <span class="text-[#a5b6a0] text-xs">→</span>
                            <span class="text-[#a5b6a0] text-sm font-semibold uppercase tracking-wider">TWD</span>
                        </div>
                        <button onclick="updateExchangeRate()" id="refresh-btn"
                            class="text-primary text-xs font-bold flex items-center gap-1 bg-primary/10 px-2 py-1 rounded-full hover:bg-primary/20 transition-colors">
                            <span class="material-symbols-outlined text-sm">sync</span> 更新
                        </button>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl text-white font-light">×</span>
                        <input id="exchange-rate" oninput="calculateTotal()"
                            class="w-full bg-transparent border-none p-0 text-4xl font-bold text-primary focus:ring-0 placeholder:text-primary/30"
                            placeholder="0.2150" type="number" step="0.0001" value="0.2150" />
                    </div>
                    <p id="update-time" class="text-xs text-[#a5b6a0]/70 mt-2">最後更新: 剛剛</p>
                </div>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">shopping_bag</span>
                        購買成本
                    </h3>
                    <div class="space-y-4">
                        <div class="group/input">
                            <label class="block text-[#a5b6a0] text-sm font-medium mb-2">離岸價格 (FOB)</label>
                            <div class="relative">
                                <input id="fob-price" oninput="calculateTotal()"
                                    class="w-full h-14 bg-surface-dark border border-border-dark rounded-2xl px-4 pl-12 text-white text-lg font-medium focus:border-primary focus:ring-1 focus:ring-primary transition-all outline-none placeholder:text-[#a5b6a0]/30"
                                    placeholder="100,000" type="number" value="128000" />
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-[#a5b6a0]">
                                    <span id="currency-symbol" class="text-lg">¥</span>
                                </div>
                            </div>
                        </div>
                        <div class="group/input">
                            <label class="block text-[#a5b6a0] text-sm font-medium mb-2">日本國內/當地運費</label>
                            <div class="relative">
                                <input id="local-shipping" oninput="calculateTotal()"
                                    class="w-full h-14 bg-surface-dark border border-border-dark rounded-2xl px-4 pl-12 text-white text-lg font-medium focus:border-primary focus:ring-1 focus:ring-primary transition-all outline-none placeholder:text-[#a5b6a0]/30"
                                    placeholder="1,000" type="number" value="1200" />
                                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-[#a5b6a0]">
                                    <span class="text-lg">¥</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">flight_takeoff</span>
                        國際物流
                    </h3>
                    <div class="group/input">
                        <label class="block text-[#a5b6a0] text-sm font-medium mb-2">國際運費</label>
                        <div class="relative">
                            <input id="intl-shipping" oninput="calculateTotal()"
                                class="w-full h-14 bg-surface-dark border border-border-dark rounded-2xl px-4 pl-12 text-white text-lg font-medium focus:border-primary focus:ring-1 focus:ring-primary transition-all outline-none placeholder:text-[#a5b6a0]/30"
                                placeholder="5,000" type="number" value="6500" />
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-[#a5b6a0]">
                                <span class="text-lg">¥</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">account_balance</span>
                        稅務試算
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="group/input">
                            <label class="block text-[#a5b6a0] text-sm font-medium mb-2">進口關稅 (%)</label>
                            <div class="relative">
                                <input id="import-duty-rate" oninput="calculateTotal()"
                                    class="w-full h-14 bg-surface-dark border border-border-dark rounded-2xl px-4 pr-10 text-white text-lg font-medium focus:border-primary focus:ring-1 focus:ring-primary transition-all outline-none placeholder:text-[#a5b6a0]/30"
                                    placeholder="0" type="number" value="5" />
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-[#a5b6a0]">
                                    <span class="text-lg">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="group/input">
                            <label class="block text-[#a5b6a0] text-sm font-medium mb-2">營業稅 (%)</label>
                            <div class="relative">
                                <input id="vat-rate" oninput="calculateTotal()"
                                    class="w-full h-14 bg-surface-dark border border-border-dark rounded-2xl px-4 pr-10 text-white text-lg font-medium focus:border-primary focus:ring-1 focus:ring-primary transition-all outline-none placeholder:text-[#a5b6a0]/30"
                                    placeholder="5" type="number" value="5" />
                                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-[#a5b6a0]">
                                    <span class="text-lg">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 歷史紀錄區塊 -->
                <div class="mt-8">
                    <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">history</span>
                        最近紀錄 (最多5筆)
                    </h3>
                    <div id="cost-history" class="space-y-3">
                        <!-- 歷史紀錄卡片會在這裡動態渲染 -->
                        <p class="text-[#a5b6a0] text-sm italic">暫無儲存紀錄</p>
                    </div>
                </div>
            </div>
        </main>

        <div
            class="absolute bottom-[80px] w-full bg-surface-dark/95 backdrop-blur-xl border-t border-border-dark px-6 py-6 pb-4 z-40 rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-end">
                    <div class="flex flex-col">
                        <span class="text-[#a5b6a0] text-sm font-medium mb-1">總落地成本 (TWD)</span>
                        <div class="flex items-baseline gap-1">
                            <span class="text-white text-2xl font-bold">NT$</span>
                            <span id="total-cost" class="text-primary text-4xl font-extrabold tracking-tight">0</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p id="total-tax" class="text-xs text-[#a5b6a0]">含稅額: NT$ 0</p>
                    </div>
                </div>
                <button onclick="saveResult()"
                    class="w-full bg-primary hover:bg-[#45b825] active:scale-[0.98] transition-all h-14 rounded-full flex items-center justify-center gap-2 group shadow-[0_0_20px_rgba(83,210,45,0.3)]">
                    <span
                        class="material-symbols-outlined text-background-dark text-xl font-bold group-hover:rotate-12 transition-transform">save</span>
                    <span class="text-background-dark text-lg font-bold">儲存計算結果</span>
                </button>
            </div>
        </div>

        <script>
            async function updateExchangeRate() {
                const base = document.getElementById('base-currency').value;
                const refreshBtn = document.getElementById('refresh-btn');
                const rateInput = document.getElementById('exchange-rate');
                const updateTimeText = document.getElementById('update-time');
                const symbolText = document.getElementById('currency-symbol');

                // 更新符號顯示
                symbolText.innerText = base === 'JPY' ? '¥' : (base === 'USD' ? '$' : '€');

                refreshBtn.classList.add('animate-spin');
                try {
                    const response = await fetch(`https://open.er-api.com/v6/latest/${base}`);
                    const data = await response.json();
                    const twdRate = data.rates.TWD;
                    rateInput.value = twdRate.toFixed(4);
                    updateTimeText.innerText = `最後更新: ${new Date().toLocaleTimeString()}`;
                    calculateTotal();
                } catch (error) {
                    console.error('匯率獲取失敗:', error);
                    alert('匯率獲取失敗，請檢查網路連線');
                } finally {
                    refreshBtn.classList.remove('animate-spin');
                }
            }

            function calculateTotal() {
                const FOB = parseFloat(document.getElementById('fob-price').value) || 0;
                const localShipping = parseFloat(document.getElementById('local-shipping').value) || 0;
                const intlShipping = parseFloat(document.getElementById('intl-shipping').value) || 0;
                const rate = parseFloat(document.getElementById('exchange-rate').value) || 0;
                const dutyRate = (parseFloat(document.getElementById('import-duty-rate').value) || 0) / 100;
                const vatRate = (parseFloat(document.getElementById('vat-rate').value) || 0) / 100;

                // 邏輯: 
                // 1. 購買原價 TWD = (FOB + 當地運費) * 匯率
                // 2. 國際運費 TWD = 國際運費原幣 * 匯率 (假設運費也是原幣計價)
                // 3. 完稅價格 (CIF) = 購買原 TWD + 國際運 TWD
                // 4. 進口稅 = CIF * 進口稅率
                // 5. 營業稅 = (CIF + 進口稅) * 營業稅率

                const itemCostTwd = (FOB + localShipping) * rate;
                const shippingTwd = intlShipping * rate;
                const cifTwd = itemCostTwd + shippingTwd;

                const dutyTwd = cifTwd * dutyRate;
                const vatTwd = (cifTwd + dutyTwd) * vatRate;
                const totalTax = dutyTwd + vatTwd;
                const totalResult = cifTwd + totalTax;

                document.getElementById('total-cost').innerText = Math.round(totalResult).toLocaleString();
                document.getElementById('total-tax').innerText = `含稅額: NT$ ${Math.round(totalTax).toLocaleString()}`;

                return { totalResult, totalTax, FOB, base: document.getElementById('base-currency').value };
            }

            function saveResult() {
                const data = calculateTotal();
                const historyObj = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    base: data.base,
                    fob: data.FOB,
                    total: Math.round(data.totalResult)
                };

                let history = JSON.parse(localStorage.getItem('stitch_cost_history')) || [];
                history.unshift(historyObj);

                // 最多保留 5 筆
                if (history.length > 5) history = history.slice(0, 5);

                localStorage.setItem('stitch_cost_history', JSON.stringify(history));
                renderHistory();
            }

            function renderHistory() {
                const historyContainer = document.getElementById('cost-history');
                const history = JSON.parse(localStorage.getItem('stitch_cost_history')) || [];

                if (history.length === 0) {
                    historyContainer.innerHTML = '<p class="text-[#a5b6a0] text-sm italic">暫無儲存紀錄</p>';
                    return;
                }

                historyContainer.innerHTML = history.map(item => `
                    <div class="bg-surface-dark border border-border-dark p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="flex flex-col">
                            <span class="text-white font-bold text-sm">${item.base} ${item.fob.toLocaleString()} → NT$ ${item.total.toLocaleString()}</span>
                            <span class="text-[#a5b6a0] text-[10px]">${item.date}</span>
                        </div>
                        <span class="material-symbols-outlined text-primary text-sm">check_circle</span>
                    </div>
                `).join('');
            }

            function clearFields() {
                document.querySelectorAll('input').forEach(input => {
                    if (input.type === 'number') input.value = '';
                });
                calculateTotal();
            }

            window.onload = () => {
                renderHistory();
                calculateTotal();
            };
        </script>

        <!-- iOS Bottom Tab Bar -->
        <nav
            class="fixed bottom-0 left-0 right-0 glass-effect ios-tab-bar px-6 flex justify-between items-center z-50 max-w-md mx-auto">
            <a href="../匯率追蹤器/dashboard.html" class="flex flex-col items-center p-3 text-[#a5b6a0]">
                <span class="material-symbols-outlined">home</span>
                <span class="text-[10px] mt-1">首頁</span>
            </a>
            <a href="../匯率追蹤器/code.html" class="flex flex-col items-center p-3 text-[#a5b6a0]">
                <span class="material-symbols-outlined">payments</span>
                <span class="text-[10px] mt-1">匯率</span>
            </a>
            <a href="../單品庫存管理/code.html" class="flex flex-col items-center p-3 text-[#a5b6a0]">
                <span class="material-symbols-outlined">box</span>
                <span class="text-[10px] mt-1">庫存</span>
            </a>
            <a href="code.html" class="flex flex-col items-center p-3 text-primary">
                <span class="material-symbols-outlined fill-[1]">receipt_long</span>
                <span class="text-[10px] mt-1 font-bold">成本</span>
            </a>
            <a href="../銷售記錄與利潤分析/code.html" class="flex flex-col items-center p-3 text-[#a5b6a0]">
                <span class="material-symbols-outlined">monitoring</span>
                <span class="text-[10px] mt-1">分析</span>
            </a>
        </nav>
    </div>
</body>

</html>