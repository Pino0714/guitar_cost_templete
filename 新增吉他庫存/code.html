<!DOCTYPE html>
<html class="dark" lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>æ–°å¢å‰ä»–åº«å­˜</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#53d22d",
                        "background-light": "#f6f8f6",
                        "background-dark": "#152012",
                        "surface-dark": "#1f251d",
                        "surface-border": "#2d372a",
                        "text-secondary": "#a5b6a0",
                    },
                    fontFamily: {
                        "display": ["Manrope", "Noto Sans", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #152012;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d372a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #53d22d;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            min-height: max(884px, 100dvh);
            -webkit-tap-highlight-color: transparent;
        }

        .glass-effect {
            background: rgba(31, 37, 29, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ios-tab-bar {
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
    </style>
</head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white antialiased selection:bg-primary selection:text-black">
    <div
        class="relative flex h-full min-h-screen w-full flex-col overflow-x-hidden max-w-md mx-auto shadow-2xl bg-background-light dark:bg-background-dark pb-24">
        <div
            class="sticky top-0 z-50 flex items-center bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm p-4 pb-2 justify-between border-b border-gray-200 dark:border-surface-border">
            <div
                class="text-slate-900 dark:text-white flex size-12 shrink-0 items-center justify-start cursor-pointer transition-opacity hover:opacity-70">
                <span class="material-symbols-outlined text-2xl">close</span>
            </div>
            <h2
                class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">
                æ–°å¢å‰ä»–åº«å­˜</h2>
        </div>
        <div class="flex flex-col items-center justify-center pt-6 pb-2 px-4">
            <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="previewImage(this)">
            <div class="relative group cursor-pointer" onclick="document.getElementById('image-upload').click()">
                <div id="image-preview-container"
                    class="overflow-hidden w-28 h-28 rounded-full border-4 border-dashed border-primary/30 group-hover:border-primary transition-colors flex items-center justify-center bg-surface-dark relative">
                    <span id="upload-icon"
                        class="material-symbols-outlined text-4xl text-primary/50 group-hover:text-primary transition-colors">add_a_photo</span>
                    <img id="image-preview" class="hidden w-full h-full object-cover">
                </div>
                <div
                    class="absolute bottom-0 right-0 bg-primary rounded-full p-1.5 shadow-lg border-2 border-background-dark flex items-center justify-center">
                    <span class="material-symbols-outlined text-black text-sm font-bold">edit</span>
                </div>
            </div>
            <p onclick="document.getElementById('image-upload').click()"
                class="text-primary text-sm font-medium leading-normal pb-3 pt-3 text-center cursor-pointer hover:underline">
                å¾ç›¸ç°¿é¸å–ç…§ç‰‡</p>
        </div>
        <div class="px-4 pt-4">
            <h3
                class="text-slate-900 dark:text-white tracking-light text-xl font-bold leading-tight text-left pb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">info</span>
                åŸºæœ¬è³‡è¨Š
            </h3>
            <div class="flex flex-col gap-4">
                <div class="flex gap-4">
                    <label class="flex flex-col min-w-40 flex-1 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            å“ç‰Œ <span class="text-red-500">*</span></p>
                        <input id="input-brand"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm"
                            placeholder="ä¾‹å¦‚: Fender" />
                    </label>
                </div>
                <div class="flex gap-4">
                    <label class="flex flex-col min-w-40 flex-1 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            å‹è™Ÿ <span class="text-red-500">*</span></p>
                        <input id="input-model"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm"
                            placeholder="ä¾‹å¦‚: Stratocaster" />
                    </label>
                </div>
                <div class="flex gap-4">
                    <label class="flex flex-col w-1/3 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            å¹´ä»½</p>
                        <input id="input-year"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm"
                            placeholder="2024" type="number" />
                    </label>
                    <label class="flex flex-col flex-1 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            ç”¢åœ°</p>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-text-secondary">public</span>
                            <input id="input-origin"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary pl-12 pr-5 text-base font-normal leading-normal transition-all shadow-sm"
                                placeholder="ä¾‹å¦‚: USA" />
                        </div>
                    </label>
                </div>
            </div>
        </div>
        <div class="h-px bg-gray-200 dark:bg-surface-border mx-4 my-6"></div>
        <div class="px-4">
            <h3
                class="text-slate-900 dark:text-white tracking-light text-xl font-bold leading-tight text-left pb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">qr_code_2</span>
                è©³ç´°è¦æ ¼
            </h3>
            <div class="flex flex-col gap-4">
                <label class="flex flex-col min-w-40 flex-1 group">
                    <p
                        class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                        åºè™Ÿ</p>
                    <input id="input-serial"
                        class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm font-mono tracking-wide"
                        placeholder="SN12345678" />
                </label>
                <div class="flex flex-col gap-2">
                    <p class="text-slate-700 dark:text-white text-sm font-medium leading-normal ml-1">åº«å­˜ç‹€æ…‹</p>
                    <div id="status-toggle"
                        class="flex bg-gray-100 dark:bg-surface-dark p-1 rounded-full border border-gray-200 dark:border-surface-border">
                        <button onclick="setStatus('æ–°å“')" id="btn-status-new"
                            class="flex-1 rounded-full py-2 text-sm font-bold shadow-sm bg-primary text-black transition-all">æ–°å“</button>
                        <button onclick="setStatus('äºŒæ‰‹')" id="btn-status-used"
                            class="flex-1 rounded-full py-2 text-sm font-medium text-gray-500 dark:text-text-secondary transition-all">äºŒæ‰‹</button>
                    </div>
                    <input type="hidden" id="input-status" value="æ–°å“">
                </div>
            </div>
        </div>
        <div class="h-px bg-gray-200 dark:bg-surface-border mx-4 my-6"></div>
        <div class="px-4 pb-4">
            <h3
                class="text-slate-900 dark:text-white tracking-light text-xl font-bold leading-tight text-left pb-4 flex items-center gap-2">
                <span class="material-symbols-outlined text-primary">paid</span>
                è³¼å…¥æˆæœ¬
            </h3>
            <div class="flex flex-col gap-4">
                <div class="flex gap-4">
                    <label class="flex flex-col flex-1 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            è³¼å…¥æ—¥æœŸ</p>
                        <div class="relative">
                            <span
                                class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-text-secondary pointer-events-none">calendar_today</span>
                            <input id="input-date"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm appearance-none"
                                type="date" value="2023-10-27" />
                        </div>
                    </label>
                </div>
                <div class="flex gap-4 items-end">
                    <label class="flex flex-col w-1/3 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            å¹£åˆ¥</p>
                        <div class="relative">
                            <select id="input-currency"
                                class="form-select w-full rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 px-5 text-base font-normal leading-normal transition-all shadow-sm appearance-none cursor-pointer">
                                <option>USD</option>
                                <option>JPY</option>
                                <option>TWD</option>
                                <option>EUR</option>
                            </select>
                            <span
                                class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-text-secondary pointer-events-none text-sm">expand_more</span>
                        </div>
                    </label>
                    <label class="flex flex-col flex-1 group">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal pb-2 ml-1 group-focus-within:text-primary transition-colors">
                            è³¼å…¥é‡‘é¡</p>
                        <input id="input-amount"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm"
                            placeholder="0.00" type="number" />
                    </label>
                </div>
                <label class="flex flex-col flex-1 group">
                    <div class="flex justify-between items-center pb-2 ml-1">
                        <p
                            class="text-slate-700 dark:text-white text-sm font-medium leading-normal group-focus-within:text-primary transition-colors">
                            è³¼å…¥åŒ¯ç‡</p>
                    </div>
                    <div class="relative">
                        <input id="input-exchange-rate"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-full text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-300 dark:border-surface-border bg-white dark:bg-surface-dark focus:border-primary h-12 placeholder:text-gray-400 dark:placeholder:text-text-secondary px-5 text-base font-normal leading-normal transition-all shadow-sm"
                            placeholder="ä¾‹å¦‚: 32.5" step="0.01" type="number" />
                        <span
                            class="absolute right-5 top-1/2 -translate-y-1/2 text-gray-400 dark:text-text-secondary text-sm font-mono">TWD</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Firebase SDKs -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
            import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
            import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBGDUjeYPCwESykwTWStz7GLMe1ujzEr08",
                authDomain: "test-5e965.firebaseapp.com",
                projectId: "test-5e965",
                storageBucket: "test-5e965.firebasestorage.app",
                messagingSenderId: "42477514336",
                appId: "1:42477514336:web:e6495a7c4081d780c89d05",
                measurementId: "G-G9ZEBGGZQM"
            };

            const app = initializeApp(firebaseConfig);
            const storage = getStorage(app);
            const db = getFirestore(app);
            const auth = getAuth(app);

            console.log("%cğŸš€ FIREBASE APP LOADED - VERSION 2.1", "color: #53d22d; font-size: 16px; font-weight: bold;");

            // è¨±å¯åå–® (è½‰ç‚ºå°å¯«å­˜å…¥)
            const allowList = ['monkey30d@gmail.com'].map(e => e.toLowerCase());

            // å­˜å–æª¢æŸ¥ (Auth Guard)
            onAuthStateChanged(auth, (user) => {
                if (!user || !allowList.includes(user.email.toLowerCase())) {
                    console.warn("ğŸ” Unauthorized access attempt:", user ? user.email : "No User");
                    window.location.href = '../é¦–é /code.html';
                } else {
                    console.log("âœ… Authorized as:", user.email);
                    document.body.classList.remove('invisible');
                }
            });

            let selectedFile = null;

            window.previewImage = function (input) {
                if (input.files && input.files[0]) {
                    selectedFile = input.files[0];
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('image-preview');
                        const icon = document.getElementById('upload-icon');
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        icon.classList.add('hidden');
                    };
                    reader.readAsDataURL(selectedFile);
                }
            }

            window.saveGuitar = async function () {
                console.log("ğŸš€ Starting saveGuitar...");

                try {
                    const brand = document.getElementById('input-brand').value;
                    const model = document.getElementById('input-model').value;
                    const year = document.getElementById('input-year').value;
                    const origin = document.getElementById('input-origin').value;
                    const serial = document.getElementById('input-serial').value;
                    const status = document.getElementById('input-status').value;
                    const amount = document.getElementById('input-amount').value;
                    const currency = document.getElementById('input-currency').value;
                    const date = document.getElementById('input-date').value;

                    console.log("ğŸ“¦ Form data:", { brand, model, amount, date });

                    if (!brand || !model) {
                        alert('è«‹å¡«å¯«å“ç‰Œèˆ‡å‹è™Ÿ');
                        return;
                    }

                    const btn = document.getElementById('save-btn');
                    if (!btn) {
                        console.error("âŒ Button not found!");
                        return;
                    }

                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="text-black text-lg font-bold tracking-tight">å„²å­˜ä¸­...</span>';

                    let imageUrl = '';

                    // 1. å¦‚æœæœ‰é¸æª”æ¡ˆï¼Œå…ˆä¸Šå‚³åˆ° Firebase Storage
                    if (selectedFile) {
                        console.log("ğŸ“¸ Uploading image:", selectedFile.name);
                        const storageRef = ref(storage, 'guitar_images/' + Date.now() + '_' + selectedFile.name);
                        const snapshot = await uploadBytes(storageRef, selectedFile);
                        imageUrl = await getDownloadURL(snapshot.ref);
                        console.log("ğŸ”— Image URL:", imageUrl);
                    }

                    // 2. å»ºç«‹æ–°è³‡æ–™ç‰©ä»¶
                    const newGuitar = {
                        brand, model, year, origin, serial, status,
                        amount: parseFloat(amount) || 0,
                        currency,
                        date,
                        image: imageUrl,
                        inStock: true,
                        createdAt: serverTimestamp()
                    };

                    console.log("â˜ï¸ Saving to Firestore...");
                    // 3. å­˜å…¥ Firestore (é›²ç«¯åŒæ­¥)
                    const docRef = await addDoc(collection(db, "inventory"), newGuitar);
                    console.log("âœ… Success! ID:", docRef.id);

                    alert('âœ… é›²ç«¯å„²å­˜æˆåŠŸï¼');
                    // æš«æ™‚è¨»è§£æ‰è·³è½‰,æ–¹ä¾¿é™¤éŒ¯
                    // window.location.href = '../å–®å“åº«å­˜ç®¡ç†/code.html';

                } catch (error) {
                    console.error("ğŸ”¥ Error saving guitar:", error);
                    alert("âŒ å„²å­˜å¤±æ•—: " + error.message);
                } finally {
                    const btn = document.getElementById('save-btn');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<span class="text-black text-lg font-bold tracking-tight">æ–°å¢</span>';
                    }
                }
            }
        </script>

        <script>
            function setStatus(status) {
                const btnNew = document.getElementById('btn-status-new');
                const btnUsed = document.getElementById('btn-status-used');
                const statusInput = document.getElementById('input-status');

                statusInput.value = status;

                if (status === 'æ–°å“') {
                    btnNew.className = 'flex-1 rounded-full py-2 text-sm font-bold shadow-sm bg-primary text-black transition-all';
                    btnUsed.className = 'flex-1 rounded-full py-2 text-sm font-medium text-gray-500 dark:text-text-secondary transition-all';
                } else {
                    btnUsed.className = 'flex-1 rounded-full py-2 text-sm font-bold shadow-sm bg-primary text-black transition-all';
                    btnNew.className = 'flex-1 rounded-full py-2 text-sm font-medium text-gray-500 dark:text-text-secondary transition-all';
                }
            }
        </script>

        <div class="fixed bottom-[90px] left-0 right-0 p-4 z-40 max-w-md mx-auto">
            <button id="save-btn" onclick="saveGuitar()"
                class="w-full h-14 bg-primary hover:bg-[#45b825] active:scale-[0.98] transition-all rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(83,210,45,0.3)]">
                <span class="text-black text-lg font-bold tracking-tight">æ–°å¢</span>
            </button>
        </div>

        <!-- iOS Bottom Tab Bar -->
        <nav
            class="fixed bottom-0 left-0 right-0 glass-effect ios-tab-bar px-6 flex justify-between items-center z-50 max-w-md mx-auto">
            <a href="../åŒ¯ç‡è¿½è¹¤å™¨/dashboard.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">home</span>
                <span class="text-[10px] mt-1">é¦–é </span>
            </a>
            <a href="../åŒ¯ç‡è¿½è¹¤å™¨/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">payments</span>
                <span class="text-[10px] mt-1">åŒ¯ç‡</span>
            </a>
            <a href="../å–®å“åº«å­˜ç®¡ç†/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">box</span>
                <span class="text-[10px] mt-1">åº«å­˜</span>
            </a>
            <a href="../è½åœ°æˆæœ¬è¨ˆç®—å™¨/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">receipt_long</span>
                <span class="text-[10px] mt-1">æˆæœ¬</span>
            </a>
            <a href="../éŠ·å”®è¨˜éŒ„èˆ‡åˆ©æ½¤åˆ†æ/code.html" class="flex flex-col items-center p-3 text-text-secondary">
                <span class="material-symbols-outlined">monitoring</span>
                <span class="text-[10px] mt-1">åˆ†æ</span>
            </a>
        </nav>

    </div>

</body>

</html>
